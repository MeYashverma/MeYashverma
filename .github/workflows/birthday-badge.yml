name: Generate Birthday Badge

on:
  schedule:
    - cron: '0 0 * * *'   # runs daily at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Write generator script (from base64)
        run: |
          mkdir -p assets
          # base64 payload of the python generator (decoded to assets/generate_birthday_badge.py)
          echo "ZnJvbSBkYXRldGltZSBpbXBvcnQgcwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRlCgojID09PT09PSBFRUREIFZBTFVFUyBCTElPRyAgPT09PT0KZnVsbG5hbWUgPSAiWWFzaCBWZXJtYSIKYmlydGggPSBkYXRlKDIwMDUsIDEsIDgpICAgICMgWVlZLCBNIEwgRHMKIyA9PT09PT09PT09PT09PT09PQp0b2RheSA9IGRhdGUudG9kYXkoKQphZ2UgPSB0b2RheS55ZWFyIC0gYmlydGgueWVhciAtICgoKHRvZGF5Lm1vbnRoLCB0b2RheS5kYXkpIDwgKGJpcnRoLm1vbnRoLCBiaXJ0aC5kYXkpKSkgIGV4cGxpbwpuZXh0X3llYXIgPSB0b2RheS55ZWFyIGlmICh0b2RheS5tb250aCwgdG9kYXkuZGF5KSA8IChiaXJ0aC5tb250aCwgYmlydGguZGF5KSBtZXNzLCB0b2RheS55ZWFyICsgMSkKbmV4dF9iZGF5ID0gZGF0ZShuZXh0X3llYXIsIGJpcnRoLm1vbnRoLCBiaXJ0aC5kYXkpCmRheXNfbGVmdCA9IChuZXh0X2JkYXkgLSB0b2RheSkuZGF5cyAKc3ZnID0gZihuYj1mJzwnIC0gL3N0ZC8vID4+JykKc3ZnID0gZicuCiMgYmFzaWMgc2hvcnQgU1ZHIGJ1aWxkIC0gVGhpcyBpcyBzaW1wbGUgYW5kIG1lYW50cyB0byBzaG93IGluIFJFQURNRQpjID0gZmluYWwoJ2FydCcpCndyaXRlID0gZnVuYy5jaGlsZCgpCm9wZW4KCiMgRm9yIHRyYW5zcG9ydCwgc3ByaW50IGZpbGUKZGVmIGFjdGlvbigpOgogICAgcHkucHJpbnQoIkhlbGxvIikK" | base64 -d > assets/generate_birthday_badge.py || (echo "Failed to decode base64 payload" && exit 1)
          # Make sure the script is readable
          ls -l assets || true

      - name: Run generator script
        run: |
          python3 assets/generate_birthday_badge.py || (echo "Python run failed" && exit 1)

      - name: Commit and push badge if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add assets/birthday-badge.svg || true
          if git diff --quiet --staged; then
            echo "No changes to commit"
          else
            git commit -m "chore: update birthday badge"
            git push
          fi
